
CREATE DATABASE dbDELIGHTCAKE
GO

USE dbDELIGHTCAKE
GO

-- tables
-- Table: CLIENTE
CREATE TABLE CLIENTE (
    IDCLI int identity (1,1) PRIMARY KEY,
    NOMCLI Varchar(50)  NOT NULL,
    APECLI Varchar(50)  NOT NULL,
	DNICLI char(8)  NOT NULL,
    TELCLI char(9)  NOT NULL,
    EMACLI Varchar(60)  NOT NULL,
    ESTCLI char(1)  NOT NULL,
    CODUBI char (6)  NOT NULL,
	DOMCLI VARCHAR(50));
    
	INSERT INTO CLIENTE
		(NOMCLI,APECLI,DNICLI,TELCLI,EMACLI,ESTCLI,CODUBI,DOMCLI)
	VALUES
	('DANIEL','LOPEZ CANCHARI','76234902','920087382','Daniel_lopez@hotmail.com','A','150501','2 DE MAYO'),
	('MIGYEL','FLORES MIX','62386386','973821232','Migyel.Flores@hotmail.com','A','150502','29 DE JULIO'),
	('MARIO', 'MAMADI GUTIERRES','57367287','914215788','MamadiGutierre@hotmail.com','A','150502','2 DE MAYO'),
	('JOSE','MAXMA LINGA','56486287','996545788','Maxmalinga@hotmail.com','I','150503','2 DE MAYO'),
	('MARIA','BROS GONZALES','74623287','996215248','Maria_10@hotmail.com','A','150505','2 DE MAYO'),
	('LUIS','MELAZCO MARUIN','65402343','912215788','Melazco12@hotmail.com','I','150503','2 DE MAYO'),
	('FERNANDO','REINA MIMADI','78728723','996546788','Fernando.Mimadi@hotmail.com','I','150505','2 DE MAYO'),
	('ESTEBAN','PIXILIONGO MIZERO','45232302','995615788','Pixiliongo@hotmail.com','I','150503','2 DE MAYO'),
	('PEDRO', 'CANCHARI MAXMA','42105213','964561718','Canchari_Maxma@hotmail.com','A','150501','2 DE MAYO'),
	('FRANCO','LOREX HUAMAN','4051902','996215745','Lorex.12@hotmail.com','A','150502','2 DE MAYO'),
	('MARCO', 'DIAZ MARTINEZ','34309021','976215732','MarcoMartinez@hotmail.com','I','150504','2 DE MAYO'),
	('STAR','VALIAS FLORES','67228702','944575785','Flores.123@hotmail.com','A','150505','2 DE MAYO'),
	('BLANCA','FLORES ACEVEDO','98326102','996223586','BlancaFlores@hotmail.com','I','150506','2 DE MAYO'),
	('ROSA','MAXI MARUA','76422102','996248478','maruaRosa@hotmail.com','A','150502','2 DE MAYO'),
	('MANUEL','LOPEZ MAXIMA','34234533','996254788','MaximaManuel@hotmail.com','A','150503','2 DE MAYO'),
	('DIEGO','CANCHARI MATAMA','68089027','946815783','Canchari@hotmail.com','A','150504','2 DE MAYO'),
	('MARIO','BERROCAL ZENTENO','40845501','996286468','BerrocalMario@hotmail.com','I','150505','2 DE MAYO'),
	('LUIS','LOPEZ SANCHEZ','51234902','993155782','LopezSanchez@hotmail.com','I','150507','2 DE MAYO'),
	('XIMENA','LOPEZ CANCHARI','40254502','965415718','Ximena@hotmail.com','I','150508','2 DE MAYO'),
	('MAXIMO','CANCHARI SIERRA','77343233','985215788','Maximo@hotmail.com','I','150501','2 DE MAYO');
Go

-- Table: EMPLEADO
CREATE TABLE EMPLEADO (
    IDEMP int identity (1,1) PRIMARY KEY,
    NOMEMP varchar(50)  NOT NULL,
    APEEMP varchar(50)  NOT NULL,
    DNIEMP char(8)  NOT NULL,
    TELEMP char(9)  NOT NULL,
    ESTEMP char(1)  NOT NULL,
	EMAEMP Varchar(60)  NOT NULL,
    ROLEMP varchar(30)  NOT NULL,
	CODUBI char (6)  NOT NULL);
	

	INSERT INTO EMPLEADO
	(NOMEMP,APEEMP,DNIEMP,TELEMP,ESTEMP,EMAEMP,ROLEMP,CODUBI)
	VALUES
	('MARIA','EMILIA LOPEZ','74247242','998756524','A','MariaEmilia@hotmail.com','EMPLEADA','150501'),
	('JUAN','HERNANDEZ LOPEZ','86568655','965454224','A','Hernadez@hotmail.com','EMPLEADO','150502'),
	('MARIO','LOZAR LANLI','74854242','998754224','I','Lanli@hotmail.com','EMPLEADO','150501'),
	('LUISA','HERNAN LONZI','01854242','998747224','A','Luisa@hotmail.com','EMPLEADA','150503'),
	('JIAMPIER','ZAMBIA LOZAR','65414242','941754224','I','Lozar@hotmail.com','EMPLEADO','150502'),
	('GEORGE','MARIANO MARCOS','32554242','985124224','A','Marcos@hotmail.com', 'EMPLEADO','150503'),
	('MIGUEL','JUAZMAN LAZANO','12454242','936144224','A','Miguel@hotmail.com','EMPLEADO','150514'),
	('XIMENA','LANZAR LOPEZ','18654222','998755644','A','Ximena@hotmail.com','EMPLEADA','150504'),
	('PEDRO','JARMEN MARINAL','85854142','998232224','A','Marinal@hotmail.com','EMPLEADO','150503'),
	('JUAN','PADRETION MADRINO','96554242','946554224','A','Juan@hotmail.com','EMPLEADO','150501'),
	('MANUEL','LAZARO ROSAS','01114242','944554224','I','Lazaro@hotmail.com','EMPLEADO','150501'),
	('CARLOS','PARIONAS ROSAS','23354242','933354224','I','Rosas@hotmail.com','EMPLEADO','150501'),
	('BEN','TENISON MADERE','45554242','998788824','A','ben@hotmail.com','EMPLEADO','150514'),
	('MORTY','JAZMEN LISPER','65454242','998753333','A','Morty@hotmail.com','EMPLEADO','150502'),
	('RICK','CANCHARI MIGUEL','88665542','998788664','A','Canchari@hotmail.com','EMPLEADO','150501'),
	('MEG','GRIFFING LAZARO','31134242','998144224','I','Lazaro@hotmail.com','EMPLEADA','150503'),
	('HUGO','ROSAS MIGUEL','35254242','998711524','A','Rosas@hotmail.com','EMPLEADO','150503'),
	('JESUS','HUAPYA RIBERAS','01254242','944422224','I','Jesus@hotmail.com','EMPLEADO','150502'),
	('MARCOS','MANZI LOPEZ','16654142','998733234','A','Marcos@hotmail.com','EMPLEADO','150501'),
	('MARIA','ZENTENO PEREZ','24253242','996554124','I','Perez@hotmail.com','EMPLEADA','150501');
  
GO


-- Table: PRODUCTO
CREATE TABLE PRODUCTO (
    IDPRO int identity (1,1) PRIMARY KEY,
    NOMPRO varchar(50)  NOT NULL,
    PREPRO decimal(5,2)  NOT NULL,
    DESPRO varchar(250)  NOT NULL,
	ESTPRO char(1)  NOT NULL,
	INGPRO VARCHAR(100) NOT NULL,
	STOPRO int NOT NULL);
    
	INSERT INTO PRODUCTO
		(NOMPRO, PREPRO,DESPRO,ESTPRO,INGPRO,STOPRO)
	VALUES
	('TORTA DE CHOCOLATE', '57.0', 'SI DESEA ENDULZAR SU VIDA COMPRE SU RICA TORTA DE CHOCOLATE.','A','CHOCOLATE','2'),
	('TORTA DE VAINILLA', '54.0','ES UNA TORTA ESPONJOSA','A','VAINILLA','2'),
	('TORTA MARMOLEADO', '55.0','ES UN PASTEL DULCE CONTINE COCOA Y CACAO.','A','HARINA','2'), 
	('TORTA DE TRES LECHES', '50.0','CONSISTE EN UN BISCOCHO BAÑADO CON TRES TIPOS DE LECHE ','A','LECHE EVAPORADA, CREMA DE LECHE Y LECHE CONDENSADA.','2'),
	('TORTA DE NARANJA', '40.0','CONTIENE LOS SABORES DEL JUGO DE NARANJA, RALLADURA DE LA CASCARA Y ESENCIA DE NARANJA.','A','NARANJA','2'),  
	('TORTA HELADA', '45.0','TORTA HELADA ES TANTO UN HELADO CON FORMA DE TORTA.','A','GELATINA','2'),  
	('TORTA DE SELVA NEGRA', '53.0','LA TORTA SELVA NEGRA ES UNA TARTA TIPICA DE COCINA DE BADEN.','A','HARINA, HUEVOS','2'),
	('QUEQUE DE NARANJA',' 41.0', 'ES UN DELICIOSO Y CONTIENE NARANJA QUE TIENE PROPIEDADES BENIFICIOSOS.','A','NARANJA','2'),
	('QUEQUE DE LIMON', '43.0', 'ES UN QUEQUE FORMADA POR UNA BASE DE CREMA DE LIMON.','A','LIMON','2'),
	('QUEQUE DE PIÑA', '35.0', 'ESTE ES UN DELICIOSO QUEQUE CON UN CUBIERTO DE CARAMELO.','A','PIÑA','2'),
	('QUEQUE INGLES',' 43.0','ESTA PREPARADA CON FRUTAS CON FRUTAS SECAS Y NUECES.','A','HARINA','2'),
	('QUEQUE CHIFFON', '45.0','ES UN QUEQUE MUY LIGERO.','I','HARINA,HUEVO','2'),
	('PIE DE MANZANA', '50.0','CONSISTE EN UNA MASA SUAVE Y CRUJIENTE DE MANZANAS.','A','MANZANAS','2'),
	('ALFAJORES', '16.0','ESTA RELLENAS DE JALEAS.','I','AZUCAR EN POLVO','2'),
	('CUPCAKES', '21.0', 'ES UNA PEQUEÑA TARTA INDIVIDUAL.','I','HARINA','2'),
	('EMPANADA','23.0','ESTA EMPANADA INCLUYE FRUTAS.','I','MANZANAS','2'),
	('QUEQUE DE CAFE', '54.0','ESTE TIPO DE QUEQUE INCLUYE EL FUERTE SABOR AL CAFE COMO PARTE DE SU PERFIL DE SABOR.','I','CAFE','2'),
	('QUEQUE MARMOLADO', '23.0','ESTA COMPUESTO POR UN BIZCOCHO DE VAINILLA Y UNA DE CHOCOLATE.','A','HARINA','2'),
	('QUEQUE DE MANDARINA','15.0','SE TRATA DE UN QUEQUE FACIL Y ESPONJOSO.','I','MANDARINA','2'),
	('QUEQUE CON LECHE CONDENSADA','25.0','ESTE QUEQUE CON LECHE CONDESADA ES SENCILLA Y DELICIOSA.','A','LECHE CONDESADA','2');
GO

-- Table: UBIGEO
CREATE TABLE UBIGEO (
    CODUBI CHAR(6) PRIMARY KEY,
    DEPUBI varchar(50)  NOT NULL,
    PROUBI varchar(50)  NOT NULL,
    DISUBI varchar(70)  NOT NULL);

	INSERT INTO UBIGEO
	(CODUBI,DEPUBI, PROUBI,DISUBI)
	VALUES
	
	('150501','LIMA','CAÑETE','SAN VICENTE DE CAÑETE'),
	('150502','LIMA','CAÑETE','ASIA'),
	('150503','LIMA','CAÑETE','CALANGO'),
	('150504','LIMA','CAÑETE','CERRO AZUL'),
	('150505','LIMA','CAÑETE','CHILCA'),
	('150506','LIMA','CAÑETE','COAYLLO'),
	('150507','LIMA','CAÑETE','IMPERIAL'),
	('150508','LIMA','CAÑETE','LUNAHUANA'),
	('150509','LIMA','CAÑETE','MALA'),
	('150510','LIMA','CAÑETE','NUEVO IMPERIAL'),
	('150511','LIMA','CAÑETE','PACARAN'),
	('150512','LIMA','CAÑETE','QUILMANA'),
	('150513','LIMA','CAÑETE','SAN ANTONIO'),
	('150514','LIMA','CAÑETE','SAN LUIS'),
	('150515','LIMA','CAÑETE','SANTA CRUZ DE FLORES'),
	('150516','LIMA','CAÑETE','ZUÑIGA');
GO

/* Establecemos formatos de fecha dd/mm/yyyy */
SET DATEFORMAT dmy;

-- Table: VENTA
CREATE TABLE VENTA (
    IDVEN int identity (1,1) PRIMARY KEY,
    FECVEN date NOT NULL,
    IDEMP int  NOT NULL,
    IDCLI int  NOT NULL,
	TOTVEN decimal(5,2));

	INSERT INTO VENTA
	(FECVEN,IDEMP,IDCLI,TOTVEN)
	VALUES
	
	('22/01/10','1','1','35.50'),
	('22/01/15','3','2','35.50'),
	('22/01/20','2','3','35.50'),
	('22/02/03','3','4','35.50'),
	('22/02/10','1','5','35.50'),
	('22/02/12','2','6','35.50'),
	('22/02/22','3','7','35.50'),
	('22/03/10','5','8','35.50'),
	('22/03/11','2','9','35.50'),
	('22/03/15','2','10','35.50'),
	('22/03/20','1','11','35.50'),
	('22/03/26','2','12','35.50'),
	('22/04/05','3','13','35.50'),
	('22/04/10','1','14','35.50'),
	('22/04/12','4','15','35.50'),
	('22/04/13','6','16','35.50'),
	('22/04/17','8','17','35.50'),
	('22/04/18','1','18','35.50'),
	('22/04/20','2','19','35.50'),
	('22/04/26','10','20','35.50');
	
GO

-- Table: VENTA_DETALLE
CREATE TABLE VENTA_DETALLE  (
    IDVENDET int identity (1,1) PRIMARY KEY,
    CANVENDET int  NOT NULL,
    IDVEN int  NOT NULL,
    IDPRO int  NOT NULL,
	SUBVENDET decimal (5,2));

	INSERT INTO VENTA_DETALLE
	(CANVENDET,IDVEN,IDPRO,SUBVENDET)
	VALUES
	
	('2','1','1','40.50'),
	('2','2','2','40.50'),
	('1','3','3','40.50'),
	('2','4','1','40.50'),
	('3','5','2','40.50'),
	('2','6','3','40.50'),
	('1','7','1','40.50'),
	('2','8','2','40.50'),
	('3','9','3','40.50'),
	('1','10','1','40.50'),
	('2','11','2','40.50'),
	('3','12','3','40.50');
GO


-- foreign keys
-- Reference: CLIENTE_UBIGEO (table: CLIENTE)


ALTER TABLE CLIENTE ADD CONSTRAINT CLIENTE_UBIGEO
    FOREIGN KEY (CODUBI)
    REFERENCES UBIGEO (CODUBI);

ALTER TABLE EMPLEADO ADD CONSTRAINT EMPLEADO_UBIGEO
    FOREIGN KEY (CODUBI)
    REFERENCES UBIGEO (CODUBI);

-- Reference: VENTA_CLIENTE (table: VENTA)
ALTER TABLE VENTA ADD CONSTRAINT VENTA_CLIENTE
    FOREIGN KEY (IDCLI)
    REFERENCES CLIENTE (IDCLI);

-- Reference: VENTA_Empleado (table: VENTA)
ALTER TABLE VENTA ADD CONSTRAINT VENTA_EMPLEADO
    FOREIGN KEY (IDEMP)
    REFERENCES EMPLEADO (IDEMP);

-- Reference: Venta_Detalle_PRODUCTO (table: VENTA_DETALLE)
ALTER TABLE VENTA_DETALLE ADD CONSTRAINT VENTA_DETALLE_PRODUCTO
    FOREIGN KEY (IDPRO)
    REFERENCES PRODUCTO (IDPRO);

-- Reference: Venta_Detalle_VENTA (table: VENTA_DETALLE)
ALTER TABLE VENTA_DETALLE ADD CONSTRAINT VENTA_DETALLE_VENTA
    FOREIGN KEY (IDVEN)
    REFERENCES VENTA (IDVEN);


/* Listar registros de tablas */
Select * from EMPLEADO;
SELECT * FROM CLIENTE;
SELECT * FROM UBIGEO;
SELECT * FROM PRODUCTO;

/* Listar registros de tablas TRANSACIONALES */
SELECT * FROM VENTA;
SELECT * FROM VENTA_DETALLE;
SELECT * FROM vVENTA ORDER BY IDVEN DESC;
GO

-- Vista para CLIENTE 
CREATE VIEW vCLIENTE
AS
SELECT
	 C.IDCLI AS IDCLI,
	 SUBSTRING(UPPER(C.NOMCLI),1,1) + SUBSTRING(LOWER(C.NOMCLI),2,50) AS NOMCLI,
	 SUBSTRING(UPPER(C.APECLI),1,1) + SUBSTRING(LOWER(C.APECLI),2,50) AS APECLI,
	 SUBSTRING(UPPER(C.DOMCLI),1,1) + SUBSTRING(LOWER(C.DOMCLI),2,50) AS DOMCLI,
	 C.DNICLI AS DNICLI,
	 C.EMACLI AS EMACLI,
	 C.TELCLI AS TELCLI,
	 C.ESTCLI AS ESTCLI,
	 U.CODUBI AS CODUBI,
	 U.DISUBI AS DISUBI,
	 U.PROUBI AS PROUBI,
	 U.DEPUBI AS DEPUBI,
	 ROW_NUMBER() OVER (ORDER BY C.IDCLI DESC) AS ORDEN
FROM 
     CLIENTE AS C
	 INNER JOIN UBIGEO AS U ON
	 C.CODUBI = U.CODUBI;
GO



SELECT * FROM vCLIENTE;

-- Vista para EMPLEADO 
CREATE VIEW vEMPLEADO
AS
SELECT
	 E.IDEMP AS IDEMP,
	 SUBSTRING(UPPER(E.NOMEMP),1,1) + SUBSTRING(LOWER(E.NOMEMP),2,50) AS NOMEMP,
	 SUBSTRING(UPPER(E.APEEMP),1,1) + SUBSTRING(LOWER(E.APEEMP),2,50) AS APEEMP,
	 E.DNIEMP AS DNIEMP,
	 E.TELEMP AS TELEMP,
	 E.EMAEMP AS EMAEMP,
	 E.ROLEMP AS ROLEMP,
	 E.ESTEMP AS ESTEMP,
	 U.CODUBI AS CODUBI,
	 U.DISUBI AS DISUBI,
	 U.PROUBI AS PROUBI,
	 U.DEPUBI AS DEPUBI,
	 ROW_NUMBER() OVER (ORDER BY E.IDEMP DESC) AS ORDEN
FROM 
     EMPLEADO AS E
	 INNER JOIN UBIGEO AS U ON
	 E.CODUBI = U.CODUBI;
GO

SELECT * FROM vEMPLEADO;


-- Vista para venta 
CREATE VIEW vVENTA
AS
SELECT
V.IDVEN AS IDVEN,
V.FECVEN AS FECVEN,
V.IDCLI AS IDCLI,
C.DNICLI AS DNICLI,
CONCAT(UPPER(C.APECLI), ', ', UPPER(C.NOMCLI)) AS NOMCLI,
V.TOTVEN AS TOTVEN
FROM VENTA AS V
INNER JOIN CLIENTE AS C
ON V.IDCLI = C.IDCLI
GO

SELECT * FROM vVENTA;


-- TRIGGER para restar el stock en PRODUCTO al realizar una venta
CREATE TRIGGER RESTAR_STOCK 
ON VENTA_DETALLE FOR INSERT,
UPDATE AS UPDATE PRODUCTO
SET STOPRO = P.STOPRO - VD.CANVENDET
FROM PRODUCTO AS P,
	(SELECT IDPRO, CANVENDET FROM VENTA_DETALLE
WHERE
	IDPRO = IDPRO AND IDVENDET = (SELECT MAX(IDVENDET) FROM VENTA_DETALLE)) VD
WHERE P.IDPRO = VD.IDPRO
GO


SELECT * FROM VENTA where IDVEN='10';
GO

Select * from VENTA_DETALLE WHERE IDVEN='10';
GO

 